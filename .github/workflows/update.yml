name: Update IP Databases

on:
  schedule:
    # 北京时间每天 08:00 (UTC 00:00) 运行
    - cron: '0 0 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-db:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Prepare Output Directory
        # 创建目录并给予 777 权限，确保 Docker 容器内的用户能写入文件
        run: |
          mkdir -p output
          chmod 777 output

      # ----------------------------------------------------------------
      # 1. IPinfo (Curl)
      # ----------------------------------------------------------------
      - name: Download IPinfo
        run: |
          echo "Downloading IPinfo..."
          curl -s -L -A "Mozilla/5.0" -o output/ipinfo_lite.mmdb "https://ipinfo.io/data/ipinfo_lite.mmdb?_src=frontend&token=${{ secrets.IPINFO_TOKEN }}"

      # ----------------------------------------------------------------
      # 2. DB-IP (Smart Date Fallback)
      # ----------------------------------------------------------------
      - name: Download DB-IP
        run: |
          CURRENT_MONTH=$(date +%Y-%m)
          PREV_MONTH=$(date -d "last month" +%Y-%m)
          declare -a types=("asn" "city" "country")
           
          for type in "${types[@]}"; do
            FILENAME="dbip-${type}-lite"
            URL_CURRENT="https://download.db-ip.com/free/${FILENAME}-${CURRENT_MONTH}.mmdb.gz"
            URL_PREV="https://download.db-ip.com/free/${FILENAME}-${PREV_MONTH}.mmdb.gz"
            
            if curl --output /dev/null --silent --head --fail "$URL_CURRENT"; then
              curl -s -L -o "output/${FILENAME}.mmdb.gz" "$URL_CURRENT"
            else
              curl -s -L -o "output/${FILENAME}.mmdb.gz" "$URL_PREV"
            fi

            if [ -f "output/${FILENAME}.mmdb.gz" ]; then
              gunzip -f "output/${FILENAME}.mmdb.gz"
            fi
          done

      # ----------------------------------------------------------------
      # 3. MaxMind (ALL via Official Docker)
      # 所有的 GeoLite2 数据库 (ASN, City, Country) 都通过官方工具下载
      # ----------------------------------------------------------------
      - name: Download MaxMind (Official Docker)
        continue-on-error: true
        env:
          GEOIPUPDATE_ACCOUNT_ID: ${{ secrets.MAXMIND_ACCOUNT_ID }}
          GEOIPUPDATE_LICENSE_KEY: ${{ secrets.MAXMIND_TOKEN }}
          # 在这里指定要下载的三个数据库 ID，用空格分隔
          GEOIPUPDATE_EDITION_IDS: "GeoLite2-ASN GeoLite2-City GeoLite2-Country"
          GEOIPUPDATE_FREQUENCY: "0" # 0 表示运行一次后立即退出
          GEOIPUPDATE_VERBOSE: "1"   # 开启详细日志
        run: |
          # 检查 Account ID 是否存在，如果不存在则跳过，防止报错
          if [ -z "$GEOIPUPDATE_ACCOUNT_ID" ]; then
            echo "::warning::Skipping MaxMind update because MAXMIND_ACCOUNT_ID secret is missing."
            exit 0
          fi

          echo "Starting Official GeoIP Update..."
          docker run --rm \
            -e GEOIPUPDATE_ACCOUNT_ID \
            -e GEOIPUPDATE_LICENSE_KEY \
            -e GEOIPUPDATE_EDITION_IDS \
            -e GEOIPUPDATE_FREQUENCY \
            -e GEOIPUPDATE_VERBOSE \
            -v $(pwd)/output:/usr/share/GeoIP \
            maxmindinc/geoipupdate

      # ----------------------------------------------------------------
      # 4. IP2Location (Curl)
      # ----------------------------------------------------------------
      - name: Download IP2Location
        continue-on-error: true
        run: |
          CODE="DB11.LITE.BIN"
          echo "Downloading IP2Location..."
          curl -s -L -o "ip2location.zip" "https://www.ip2location.com/download/?token=${{ secrets.IP2LOCATION_TOKEN }}&file=$CODE"
          if [ -f "ip2location.zip" ]; then
            unzip -o ip2location.zip -d output/ || rm -f ip2location.zip
            rm -f ip2location.zip
          fi

      # ----------------------------------------------------------------
      # 5. Sapics (GeoLite2 Enhanced)
      # ----------------------------------------------------------------
      - name: Download Sapics GeoLite2 Enhanced
        run: |
          echo "Downloading Sapics GeoLite2 Enhanced (High Accuracy)..."
          curl -s -L -f -o output/geolite2-geo-whois-asn-country.mmdb "https://cdn.jsdelivr.net/npm/@ip-location-db/geolite2-geo-whois-asn-country-mmdb/geolite2-geo-whois-asn-country.mmdb"

      # ----------------------------------------------------------------
      # 6. 清理与发布
      # ----------------------------------------------------------------
      - name: Delete Older Releases
        uses: dev-drprasad/delete-older-releases@v0.3.2
        with:
          keep_latest: 30
          delete_tags: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate Release Tag
        id: tag
        run: echo "release_tag=$(date +'%Y.%m.%d')" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag.outputs.release_tag }}
          name: IP Database Update ${{ steps.tag.outputs.release_tag }}
          files: output/*
          body: |
            Automatic daily update.
            Sources: 
            - IPinfo
            - DB-IP
            - MaxMind (Official Docker)
            - IP2Location
            - Sapics (GeoLite2 + GeoFeed + Whois + ASN)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
